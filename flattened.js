let sequencerData = {
    "sizes": [
        9,
        1,
        9,
        1,
        9,
        1,
        9,
        1
    ],
    "changeNodes": [
        {
            "value": 2252.18,
            "timestamp": 1746131419713,
            "parent": "Oscillator_Snake_3ef7749e23ea",
            "param": "frequency",
            "msg": "gesture",
            "historyID": "a20156b2736cc8724b4197636acb48cd78194b4295b4818ecbc9ad7d1bb2bc17",
            "branch": "main"
        },
        {
            "value": 2240.59,
            "timestamp": 1746131419731,
            "parent": "Oscillator_Snake_3ef7749e23ea",
            "param": "frequency",
            "msg": "gesture",
            "historyID": "a20156b2736cc8724b4197636acb48cd78194b4295b4818ecbc9ad7d1bb2bc17",
            "branch": "main"
        },
        {
            "value": 2228.02,
            "timestamp": 1746131419747,
            "parent": "Oscillator_Snake_3ef7749e23ea",
            "param": "frequency",
            "msg": "gesture",
            "historyID": "a20156b2736cc8724b4197636acb48cd78194b4295b4818ecbc9ad7d1bb2bc17",
            "branch": "main"
        },
        {
            "value": 2172.99,
            "timestamp": 1746131419763,
            "parent": "Oscillator_Snake_3ef7749e23ea",
            "param": "frequency",
            "msg": "gesture",
            "historyID": "a20156b2736cc8724b4197636acb48cd78194b4295b4818ecbc9ad7d1bb2bc17",
            "branch": "main"
        },
        {
            "value": 2016.97,
            "timestamp": 1746131419781,
            "parent": "Oscillator_Snake_3ef7749e23ea",
            "param": "frequency",
            "msg": "gesture",
            "historyID": "a20156b2736cc8724b4197636acb48cd78194b4295b4818ecbc9ad7d1bb2bc17",
            "branch": "main"
        },
        {
            "value": 1755.78,
            "timestamp": 1746131419797,
            "parent": "Oscillator_Snake_3ef7749e23ea",
            "param": "frequency",
            "msg": "gesture",
            "historyID": "a20156b2736cc8724b4197636acb48cd78194b4295b4818ecbc9ad7d1bb2bc17",
            "branch": "main"
        },
        {
            "value": 1591.75,
            "timestamp": 1746131419813,
            "parent": "Oscillator_Snake_3ef7749e23ea",
            "param": "frequency",
            "msg": "gesture",
            "historyID": "a20156b2736cc8724b4197636acb48cd78194b4295b4818ecbc9ad7d1bb2bc17",
            "branch": "main"
        },
        {
            "value": 1482.19,
            "timestamp": 1746131419830,
            "parent": "Oscillator_Snake_3ef7749e23ea",
            "param": "frequency",
            "msg": "gesture",
            "historyID": "a20156b2736cc8724b4197636acb48cd78194b4295b4818ecbc9ad7d1bb2bc17",
            "branch": "main"
        },
        {
            "value": 1452.36,
            "timestamp": 1746131419864,
            "parent": "Oscillator_Snake_3ef7749e23ea",
            "param": "frequency",
            "msg": "gesture",
            "historyID": "a20156b2736cc8724b4197636acb48cd78194b4295b4818ecbc9ad7d1bb2bc17",
            "branch": "main"
        },
        0,
        {
            "value": 2252.18,
            "timestamp": 1746131419713,
            "parent": "Oscillator_Snake_3ef7749e23ea",
            "param": "frequency",
            "msg": "gesture",
            "historyID": "a20156b2736cc8724b4197636acb48cd78194b4295b4818ecbc9ad7d1bb2bc17",
            "branch": "main"
        },
        {
            "value": 2240.59,
            "timestamp": 1746131419731,
            "parent": "Oscillator_Snake_3ef7749e23ea",
            "param": "frequency",
            "msg": "gesture",
            "historyID": "a20156b2736cc8724b4197636acb48cd78194b4295b4818ecbc9ad7d1bb2bc17",
            "branch": "main"
        },
        {
            "value": 2228.02,
            "timestamp": 1746131419747,
            "parent": "Oscillator_Snake_3ef7749e23ea",
            "param": "frequency",
            "msg": "gesture",
            "historyID": "a20156b2736cc8724b4197636acb48cd78194b4295b4818ecbc9ad7d1bb2bc17",
            "branch": "main"
        },
        {
            "value": 2172.99,
            "timestamp": 1746131419763,
            "parent": "Oscillator_Snake_3ef7749e23ea",
            "param": "frequency",
            "msg": "gesture",
            "historyID": "a20156b2736cc8724b4197636acb48cd78194b4295b4818ecbc9ad7d1bb2bc17",
            "branch": "main"
        },
        {
            "value": 2016.97,
            "timestamp": 1746131419781,
            "parent": "Oscillator_Snake_3ef7749e23ea",
            "param": "frequency",
            "msg": "gesture",
            "historyID": "a20156b2736cc8724b4197636acb48cd78194b4295b4818ecbc9ad7d1bb2bc17",
            "branch": "main"
        },
        {
            "value": 1755.78,
            "timestamp": 1746131419797,
            "parent": "Oscillator_Snake_3ef7749e23ea",
            "param": "frequency",
            "msg": "gesture",
            "historyID": "a20156b2736cc8724b4197636acb48cd78194b4295b4818ecbc9ad7d1bb2bc17",
            "branch": "main"
        },
        {
            "value": 1591.75,
            "timestamp": 1746131419813,
            "parent": "Oscillator_Snake_3ef7749e23ea",
            "param": "frequency",
            "msg": "gesture",
            "historyID": "a20156b2736cc8724b4197636acb48cd78194b4295b4818ecbc9ad7d1bb2bc17",
            "branch": "main"
        },
        {
            "value": 1482.19,
            "timestamp": 1746131419830,
            "parent": "Oscillator_Snake_3ef7749e23ea",
            "param": "frequency",
            "msg": "gesture",
            "historyID": "a20156b2736cc8724b4197636acb48cd78194b4295b4818ecbc9ad7d1bb2bc17",
            "branch": "main"
        },
        {
            "value": 1452.36,
            "timestamp": 1746131419864,
            "parent": "Oscillator_Snake_3ef7749e23ea",
            "param": "frequency",
            "msg": "gesture",
            "historyID": "a20156b2736cc8724b4197636acb48cd78194b4295b4818ecbc9ad7d1bb2bc17",
            "branch": "main"
        },
        0,
        {
            "value": 2252.18,
            "timestamp": 1746131419713,
            "parent": "Oscillator_Snake_3ef7749e23ea",
            "param": "frequency",
            "msg": "gesture",
            "historyID": "a20156b2736cc8724b4197636acb48cd78194b4295b4818ecbc9ad7d1bb2bc17",
            "branch": "main"
        },
        {
            "value": 2240.59,
            "timestamp": 1746131419731,
            "parent": "Oscillator_Snake_3ef7749e23ea",
            "param": "frequency",
            "msg": "gesture",
            "historyID": "a20156b2736cc8724b4197636acb48cd78194b4295b4818ecbc9ad7d1bb2bc17",
            "branch": "main"
        },
        {
            "value": 2228.02,
            "timestamp": 1746131419747,
            "parent": "Oscillator_Snake_3ef7749e23ea",
            "param": "frequency",
            "msg": "gesture",
            "historyID": "a20156b2736cc8724b4197636acb48cd78194b4295b4818ecbc9ad7d1bb2bc17",
            "branch": "main"
        },
        {
            "value": 2172.99,
            "timestamp": 1746131419763,
            "parent": "Oscillator_Snake_3ef7749e23ea",
            "param": "frequency",
            "msg": "gesture",
            "historyID": "a20156b2736cc8724b4197636acb48cd78194b4295b4818ecbc9ad7d1bb2bc17",
            "branch": "main"
        },
        {
            "value": 2016.97,
            "timestamp": 1746131419781,
            "parent": "Oscillator_Snake_3ef7749e23ea",
            "param": "frequency",
            "msg": "gesture",
            "historyID": "a20156b2736cc8724b4197636acb48cd78194b4295b4818ecbc9ad7d1bb2bc17",
            "branch": "main"
        },
        {
            "value": 1755.78,
            "timestamp": 1746131419797,
            "parent": "Oscillator_Snake_3ef7749e23ea",
            "param": "frequency",
            "msg": "gesture",
            "historyID": "a20156b2736cc8724b4197636acb48cd78194b4295b4818ecbc9ad7d1bb2bc17",
            "branch": "main"
        },
        {
            "value": 1591.75,
            "timestamp": 1746131419813,
            "parent": "Oscillator_Snake_3ef7749e23ea",
            "param": "frequency",
            "msg": "gesture",
            "historyID": "a20156b2736cc8724b4197636acb48cd78194b4295b4818ecbc9ad7d1bb2bc17",
            "branch": "main"
        },
        {
            "value": 1482.19,
            "timestamp": 1746131419830,
            "parent": "Oscillator_Snake_3ef7749e23ea",
            "param": "frequency",
            "msg": "gesture",
            "historyID": "a20156b2736cc8724b4197636acb48cd78194b4295b4818ecbc9ad7d1bb2bc17",
            "branch": "main"
        },
        {
            "value": 1452.36,
            "timestamp": 1746131419864,
            "parent": "Oscillator_Snake_3ef7749e23ea",
            "param": "frequency",
            "msg": "gesture",
            "historyID": "a20156b2736cc8724b4197636acb48cd78194b4295b4818ecbc9ad7d1bb2bc17",
            "branch": "main"
        },
        {
            "id": "d2eb8d18ccb148848eaf38c46dd928a1de5831544f06360d9b24409c745aca89",
            "label": "paramUpdate frequency = 1982.33 Oscillator_Snake",
            "color": "#6b00b8",
            "branch": "main",
            "parents": "Oscillator_Snake_3ef7749e23ea",
            "sequencerTable": null,
            "timeStamp": 1746131419305
        },
        {
            "value": 2252.18,
            "timestamp": 1746131419713,
            "parent": "Oscillator_Snake_3ef7749e23ea",
            "param": "frequency",
            "msg": "gesture",
            "historyID": "a20156b2736cc8724b4197636acb48cd78194b4295b4818ecbc9ad7d1bb2bc17",
            "branch": "main"
        },
        {
            "value": 2240.59,
            "timestamp": 1746131419731,
            "parent": "Oscillator_Snake_3ef7749e23ea",
            "param": "frequency",
            "msg": "gesture",
            "historyID": "a20156b2736cc8724b4197636acb48cd78194b4295b4818ecbc9ad7d1bb2bc17",
            "branch": "main"
        },
        {
            "value": 2228.02,
            "timestamp": 1746131419747,
            "parent": "Oscillator_Snake_3ef7749e23ea",
            "param": "frequency",
            "msg": "gesture",
            "historyID": "a20156b2736cc8724b4197636acb48cd78194b4295b4818ecbc9ad7d1bb2bc17",
            "branch": "main"
        },
        {
            "value": 2172.99,
            "timestamp": 1746131419763,
            "parent": "Oscillator_Snake_3ef7749e23ea",
            "param": "frequency",
            "msg": "gesture",
            "historyID": "a20156b2736cc8724b4197636acb48cd78194b4295b4818ecbc9ad7d1bb2bc17",
            "branch": "main"
        },
        {
            "value": 2016.97,
            "timestamp": 1746131419781,
            "parent": "Oscillator_Snake_3ef7749e23ea",
            "param": "frequency",
            "msg": "gesture",
            "historyID": "a20156b2736cc8724b4197636acb48cd78194b4295b4818ecbc9ad7d1bb2bc17",
            "branch": "main"
        },
        {
            "value": 1755.78,
            "timestamp": 1746131419797,
            "parent": "Oscillator_Snake_3ef7749e23ea",
            "param": "frequency",
            "msg": "gesture",
            "historyID": "a20156b2736cc8724b4197636acb48cd78194b4295b4818ecbc9ad7d1bb2bc17",
            "branch": "main"
        },
        {
            "value": 1591.75,
            "timestamp": 1746131419813,
            "parent": "Oscillator_Snake_3ef7749e23ea",
            "param": "frequency",
            "msg": "gesture",
            "historyID": "a20156b2736cc8724b4197636acb48cd78194b4295b4818ecbc9ad7d1bb2bc17",
            "branch": "main"
        },
        {
            "value": 1482.19,
            "timestamp": 1746131419830,
            "parent": "Oscillator_Snake_3ef7749e23ea",
            "param": "frequency",
            "msg": "gesture",
            "historyID": "a20156b2736cc8724b4197636acb48cd78194b4295b4818ecbc9ad7d1bb2bc17",
            "branch": "main"
        },
        {
            "value": 1452.36,
            "timestamp": 1746131419864,
            "parent": "Oscillator_Snake_3ef7749e23ea",
            "param": "frequency",
            "msg": "gesture",
            "historyID": "a20156b2736cc8724b4197636acb48cd78194b4295b4818ecbc9ad7d1bb2bc17",
            "branch": "main"
        },
        {
            "id": "d2eb8d18ccb148848eaf38c46dd928a1de5831544f06360d9b24409c745aca89",
            "label": "paramUpdate frequency = 1982.33 Oscillator_Snake",
            "color": "#6b00b8",
            "branch": "main",
            "parents": "Oscillator_Snake_3ef7749e23ea",
            "sequencerTable": null,
            "timeStamp": 1746131419305
        }
    ],
    "timing": [],
    "microTiming": [],
    "stepLengths": [
        "4n",
        "4n",
        "4n",
        "4n",
        "4n",
        "4n",
        "4n",
        "4n"
    ]
}


// let sequencerData = {
//     "sizes": [
//         1,
//         1,
//         1,
//         1,
//         9,
//         1,
//         1,
//         1
//     ],
//     "changeNodes": [
//         {
//             "id": "6cb26be781b4eafdecf06080dbea5282ad851c68c0c3d0a1f9507011cec3948d",
//             "label": "paramUpdate frequency = 1355.93 Oscillator_Snake",
//             "color": "#6b00b8",
//             "branch": "main",
//             "parents": "Oscillator_Snake_3ef7749e23ea",
//             "sequencerTable": null,
//             "timeStamp": 1746131418894
//         },
//         {
//             "id": "d2eb8d18ccb148848eaf38c46dd928a1de5831544f06360d9b24409c745aca89",
//             "label": "paramUpdate frequency = 1982.33 Oscillator_Snake",
//             "color": "#6b00b8",
//             "branch": "main",
//             "parents": "Oscillator_Snake_3ef7749e23ea",
//             "sequencerTable": null,
//             "timeStamp": 1746131419305
//         },
//         {
//             "id": "360af3bac2c67e3d0486a0c2e8dcbdccae9c9d27a0f82f1572c23ded46043a74",
//             "label": "connect OUT to IN",
//             "color": "#004cb8",
//             "branch": "main",
//             "parents": "Oscillator_Snake_3ef7749e23ea AudioDestination_Rabbit_8bc1f09d7627",
//             "sequencerTable": null,
//             "timeStamp": 1746131416596
//         },
//         0,
//         {
//             "value": 2252.18,
//             "timestamp": 1746131419713,
//             "parent": "Oscillator_Snake_3ef7749e23ea",
//             "param": "frequency",
//             "msg": "gesture",
//             "historyID": "a20156b2736cc8724b4197636acb48cd78194b4295b4818ecbc9ad7d1bb2bc17",
//             "branch": "main"
//         },
//         {
//             "value": 2240.59,
//             "timestamp": 1746131419731,
//             "parent": "Oscillator_Snake_3ef7749e23ea",
//             "param": "frequency",
//             "msg": "gesture",
//             "historyID": "a20156b2736cc8724b4197636acb48cd78194b4295b4818ecbc9ad7d1bb2bc17",
//             "branch": "main"
//         },
//         {
//             "value": 2228.02,
//             "timestamp": 1746131419747,
//             "parent": "Oscillator_Snake_3ef7749e23ea",
//             "param": "frequency",
//             "msg": "gesture",
//             "historyID": "a20156b2736cc8724b4197636acb48cd78194b4295b4818ecbc9ad7d1bb2bc17",
//             "branch": "main"
//         },
//         {
//             "value": 2172.99,
//             "timestamp": 1746131419763,
//             "parent": "Oscillator_Snake_3ef7749e23ea",
//             "param": "frequency",
//             "msg": "gesture",
//             "historyID": "a20156b2736cc8724b4197636acb48cd78194b4295b4818ecbc9ad7d1bb2bc17",
//             "branch": "main"
//         },
//         {
//             "value": 2016.97,
//             "timestamp": 1746131419781,
//             "parent": "Oscillator_Snake_3ef7749e23ea",
//             "param": "frequency",
//             "msg": "gesture",
//             "historyID": "a20156b2736cc8724b4197636acb48cd78194b4295b4818ecbc9ad7d1bb2bc17",
//             "branch": "main"
//         },
//         {
//             "value": 1755.78,
//             "timestamp": 1746131419797,
//             "parent": "Oscillator_Snake_3ef7749e23ea",
//             "param": "frequency",
//             "msg": "gesture",
//             "historyID": "a20156b2736cc8724b4197636acb48cd78194b4295b4818ecbc9ad7d1bb2bc17",
//             "branch": "main"
//         },
//         {
//             "value": 1591.75,
//             "timestamp": 1746131419813,
//             "parent": "Oscillator_Snake_3ef7749e23ea",
//             "param": "frequency",
//             "msg": "gesture",
//             "historyID": "a20156b2736cc8724b4197636acb48cd78194b4295b4818ecbc9ad7d1bb2bc17",
//             "branch": "main"
//         },
//         {
//             "value": 1482.19,
//             "timestamp": 1746131419830,
//             "parent": "Oscillator_Snake_3ef7749e23ea",
//             "param": "frequency",
//             "msg": "gesture",
//             "historyID": "a20156b2736cc8724b4197636acb48cd78194b4295b4818ecbc9ad7d1bb2bc17",
//             "branch": "main"
//         },
//         {
//             "value": 1452.36,
//             "timestamp": 1746131419864,
//             "parent": "Oscillator_Snake_3ef7749e23ea",
//             "param": "frequency",
//             "msg": "gesture",
//             "historyID": "a20156b2736cc8724b4197636acb48cd78194b4295b4818ecbc9ad7d1bb2bc17",
//             "branch": "main"
//         },
//         0,
//         0,
//         0
//     ],
//     "stepTiming": [],
//     "stepLengths": [
//         "4n",
//         "4n",
//         "4n",
//         "32n",
//         "4n",
//         "8n",
//         "2n",
//         "4n"
//     ]
// }

let bpm = 120 
let visited = 0
function setTiming(){
    // Convert step lengths (like "4n", "8n") to durations in milliseconds
    sequencerData.timing = getStepDurations(sequencerData.stepLengths, bpm)
    sequencerData.sizes.forEach((size, index) =>{
        // if size is only 1, we already have its duration from the line above
        // if >1 we need to calculate its duration
        if(size > 1){
            // Extract the changeNodes for this step
            let subSequence = sequencerData.changeNodes.slice(visited, (visited + size))
            // Calculate raw timestamp intervals between each pair of points
            let a = subSequence.slice(1).map((item, i) =>
                item.timestamp - subSequence[i].timestamp)
            // Estimate a final interval (e.g., using average) for the last point           
            let avgInterval = a.length > 0 ? a.reduce((a, b) => a + b, 0) / a.length : targetMs;
            a.push(avgInterval);
            // Scale intervals to match the target duration for this step
            let microTiming = scaleIntervals(a, sequencerData.timing[index])
            // Add computed durations to the microTiming array
            sequencerData.microTiming.push(...microTiming);
        } else {
            // If this step only has one changeNode, use the full step duration
            sequencerData.microTiming.push(sequencerData.timing[index]);

        }
        // Track how many changeNodes have been processed so far
        visited += size
    })

    console.log(sequencerData.microTiming, sequencerData.microTiming.length,sequencerData.changeNodes.length )
}


setTiming()

function getStepDurations(stepLengths, bpm) {
    const quarterMs = 60000 / bpm;
    return stepLengths.map(len => {
      // parse the numeric part (e.g. "8n" → 8)
      const denom = parseInt(len.replace(/\D/g, ""), 10);
      // quarter note × (4 / denom) gives the correct proportion
      return quarterMs * (4 / denom);
    });
}

function getChangeNodesSegment(sequencerData) {
    const { sizes, changeNodes } = sequencerData;
    // find the index of the first size > 1
    const startIndex = sizes.findIndex(size => size > 1);
    if (startIndex === -1) {
      return []; // no element > 1
    }
    const count = sizes[startIndex];
    // slice out `count` elements from changeNodes, starting at startIndex
    return changeNodes.slice(startIndex, startIndex + count);
}

function scaleIntervals(intervals, targetMs) {
    const sum = intervals.reduce((a, b) => a + b, 0);
    const factor = targetMs / sum;
    return intervals.map(i => i * factor);
}
